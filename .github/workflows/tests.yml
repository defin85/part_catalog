name: ðŸ§ª Tests & Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ” Analyze code
      run: flutter analyze
      
    - name: ðŸ§ª Run unit tests
      run: flutter test test/unit/ --reporter=expanded --coverage
      
    - name: ðŸŽ¨ Run widget tests  
      run: flutter test test/widgets/ --reporter=expanded
      
    - name: ðŸ”— Run integration tests
      run: flutter test test/integration/ --reporter=expanded
      
    - name: ðŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: coverage/lcov.info
        fail_ci_if_error: false
        verbose: true

  widget_tests:
    name: ðŸŽ¨ Widget Tests (Multiple Platforms)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: ðŸŽ¨ Run widget tests
      run: flutter test test/widgets/ --reporter=compact

  performance_tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: âš¡ Run performance tests
      run: |
        flutter test --reporter=json > test_results.json
        dart test/analyze_performance.dart test_results.json
        
    - name: ðŸ“Š Check for slow tests
      run: |
        if grep -q "SLOW_TEST" test_results.json; then
          echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹!"
          exit 1
        fi

  accessibility_tests:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: â™¿ Run accessibility tests
      run: flutter test test/accessibility/ --reporter=expanded

  golden_tests:
    name: ðŸ–¼ï¸ Golden Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ–¼ï¸ Run golden tests
      run: flutter test test/golden/ --reporter=expanded --update-goldens
      
    - name: ðŸ“¤ Upload golden files
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: golden-failures
        path: test/golden/failures/

  test_coverage:
    name: ðŸ“Š Test Coverage Analysis
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ðŸ”§ Generate code
      run: dart run build_runner build --delete-conflicting-outputs
      
    - name: ðŸ“Š Generate coverage report
      run: |
        flutter test --coverage
        dart test/helpers/test_generator.dart > coverage_report.txt
        
    - name: ðŸ“ˆ Check coverage threshold
      run: |
        COVERAGE=$(grep -o '[0-9]*\.[0-9]*%' coverage_report.txt | head -1 | sed 's/%//')
        echo "Current coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "âŒ ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð½Ð¸Ð·ÐºÐ¾Ðµ: $COVERAGE%"
          echo "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 80%"
          exit 1
        fi
        echo "âœ… ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ: $COVERAGE%"
        
    - name: ðŸ“¤ Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          coverage/
          coverage_report.txt

  test_dependencies:
    name: ðŸ” Test Dependencies Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Check for unused test dependencies
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
        # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
        
    - name: ðŸ” Check for missing test files
      run: |
        echo "ðŸ” ÐŸÐ¾Ð¸ÑÐº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð±ÐµÐ· Ñ‚ÐµÑÑ‚Ð¾Ð²..."
        dart test/helpers/test_generator.dart --check-missing
        
    - name: ðŸ“Š Generate test metrics
      run: |
        echo "ðŸ“Š Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
        find test/ -name "*_test.dart" | wc -l > test_count.txt
        echo "ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²: $(cat test_count.txt)"

  # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð´Ð¶Ð¾Ð±Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²
  test_quality:
    name: ðŸŽ¯ Test Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Check test naming conventions
      run: |
        echo "ðŸŽ¯ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ð¹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²..."
        BAD_NAMES=$(find test/ -name "*.dart" | grep -v "_test.dart$" | grep -v "test_" | grep -v "helpers/" | grep -v "mocks/")
        if [ ! -z "$BAD_NAMES" ]; then
          echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸:"
          echo "$BAD_NAMES"
          exit 1
        fi
        echo "âœ… Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ñ‹"
        
    - name: ðŸ” Check test completeness
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð»Ð½Ð¾Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¾Ð²..."
        dart test/helpers/test_generator.dart --analyze-completeness
        
    - name: ðŸ“Š Test performance analysis
      run: |
        echo "ðŸ“Š ÐÐ½Ð°Ð»Ð¸Ð· Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²..."
        flutter test --reporter=json > test_performance.json
        dart test/analyze_test_performance.dart test_performance.json