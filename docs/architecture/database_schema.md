# Структура БД и маппинги

> В этом документе описана структура базы данных приложения Part Catalog, включая схему таблиц, отношения между ними и механизмы маппинга данных.

## Содержание
- [Обзор](#обзор)
- [Технология и подход](#технология-и-подход)
- [Структура таблиц](#структура-таблиц)
- [Отношения и связи](#отношения-и-связи)
- [Маппинг моделей](#маппинг-моделей)
- [Миграции](#миграции)
- [Навигация](#навигация)
- [Оптимизация и индексы](#оптимизация-и-индексы)

## Обзор

База данных Part Catalog реализована с использованием SQLite через ORM-библиотеку Drift. Она обеспечивает локальное хранение данных о клиентах, автомобилях, заказ-нарядах и связанных с ними сущностях. Дополнительно реализована синхронизация с облачной базой Supabase для мультиустройственных сценариев.

## Технология и подход

### Используемые технологии:

ORM-система: Drift (SQLite wrapper для Dart/Flutter)
Базовая БД: SQLite
Облачная синхронизация: Supabase (PostgreSQL)

### Ключевые особенности:

Мягкое удаление: Записи помечаются как удаленные через поле deletedAt вместо физического удаления
Реактивные запросы: Использование стримов для наблюдения за изменениями данных
Кодогенерация: Автоматическая генерация кода для взаимодействия с БД
Двухуровневая архитектура моделей: Разделение на модели таблиц и бизнес-модели

## Структура таблиц

| Таблица         | Описание                                                                 |
|------------------|--------------------------------------------------------------------------| 
|------------------|--------------------------------------------------------------------------|
| ClientsItems     | Информация о клиентах, включая имя, телефон и адрес                     |
| CarsItems        | Данные об автомобилях клиентов, включая марку, модель и год выпуска      |
| OrdersItems      | Заказ-наряды, связывающие клиентов и автомобили с деталями заказа        |
| OrderPartsItems  | Таблица для хранения запчастей, связанных с заказ-нарядами.                   |
| OrderServicesItems | Услуги, связанные с заказ-нарядами, включая описание и стоимость       |
| PartsItems       | Информация о деталях, включая название, артикул и цену                   |
| SuppliersItems   | Поставщики деталей, включая название и контактную информацию             |
| OrderStatusItems | Статусы заказов, включая "в работе", "завершен" и "отменен"             |
| PartsCategoriesItems | Категории деталей, включая название и описание                          |
| PartsSuppliersItems  | Связь между деталями и поставщиками, включая цену и условия поставки    |
| UsersItems       | Пользователи системы, включая имя, email и пароль                        |
| RolesItems       | Роли пользователей, включая "администратор", "менеджер" и "клиент"      |
| PermissionsItems | Права доступа, связанные с ролями пользователей                         |
| AuditLogsItems   | Логи аудита, включая действия пользователей и время выполнения           |
| SettingsItems    | Настройки приложения, включая язык, тему и уведомления                  |
| AppInfoItems     | Служебная таблица для метаданных приложения                              |
|------------------|--------------------------------------------------------------------------|

## Отношения и связи

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   ClientsItems  │       │    CarsItems    │       │   OrdersItems   │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │◄──┐   │ id              │◄──┐   │ id              │
│ type            │   │   │ clientId        │───┘   │ clientId        │───┐
│ name            │   └───│ make            │       │ carId           │───┘
│ contactInfo     │       │ model           │       │ orderNumber     │
│ additionalInfo  │       │ year            │       │ createdAt       │
│ deletedAt       │       │ vin             │       │ scheduledDate   │
└─────────────────┘       │ licensePlate    │       │ completedAt     │
                          │ additionalInfo  │       │ status          │
                          │ deletedAt       │       │ description     │
                          └─────────────────┘       │ totalAmount     │
                                                    │ deletedAt       │
                                                    └─────────┬───────┘
                                                              │
                          ┌─────────────────┐       ┌─────────┴───────┐
                          │OrderServicesItems│       │ OrderPartsItems │
                          ├─────────────────┤       ├─────────────────┤
                          │ id              │       │ id              │
                          │ orderId         │───┐   │ orderId         │───┐
                          │ name            │   └───│ partNumber      │   │
                          │ description     │       │ name            │   │
                          │ price           │       │ brand           │   │
                          │ duration        │       │ quantity        │   │
                          │ performedBy     │       │ price           │   │
                          │ isCompleted     │       │ supplierName    │   │
                          └─────────────────┘       │ deliveryDays    │   │
                                                    │ isOrdered       │   │
                                                    │ isReceived      │   │
                                                    └─────────────────┘   │
                                                                          │
```

### Описание связей:

ClientsItems → CarsItems: Один-ко-многим (один клиент имеет много автомобилей)
ClientsItems → OrdersItems: Один-ко-многим (один клиент имеет много заказ-нарядов)
CarsItems → OrdersItems: Один-ко-многим (один автомобиль имеет много заказ-нарядов)
OrdersItems → OrderPartsItems: Один-ко-многим (один заказ-наряд содержит много запчастей)
OrdersItems → OrderServicesItems: Один-ко-многим (один заказ-наряд содержит много работ)
PartsItems → PartsSuppliersItems: Один-ко-многим (одна запчасть может иметь много поставщиков)
PartsCategoriesItems → PartsItems: Один-ко-многим (одна категория может содержать много запчастей)
SuppliersItems → PartsSuppliersItems: Один-ко-многим (один поставщик может предлагать много запчастей)
UsersItems → RolesItems: Один-ко-многим (один пользователь может иметь много ролей)
RolesItems → PermissionsItems: Один-ко-многим (одна роль может иметь много прав доступа)
AuditLogsItems → UsersItems: Один-ко-многим (один пользователь может иметь много логов аудита)
SettingsItems → AppInfoItems: Один-ко-многим (одна настройка может относиться к многим метаданным приложения)

## Маппинг моделей

### Трехуровневая архитектура моделей:

1. Модели таблиц (Items) - Представляют структуру таблиц в БД (ClientsItem, OrdersItem). Генерируются Drift.
2. Модели данных (@freezed, Data) - Чистые иммутабельные структуры для хранения данных (EntityCoreData, OrderSpecificData, ClientData). Используются для передачи данных между слоями Infrastructure и Domain.
3. Бизнес-модели (Композиторы, Composite) - Реализуют интерфейсы (IEntity, IDocumentEntity), содержат бизнес-логику и композируют модели данных (OrderModelComposite, ClientModelComposite). Используются в слоях Domain и Application.

### Маппинг между моделями:

**Data Layer (DAO/Repository) <-> Domain Layer (Service):**

**Из БД в Domain:**
1. DAO получает данные из БД в виде моделей таблиц (ClientsItem).
2. Репозиторий или Сервис маппит модели таблиц в соответствующие модели данных (@freezed) (EntityCoreData, ClientData).
3. Сервис использует фабричные конструкторы классов-композиторов (ClientModelComposite.create или ClientModelComposite.fromData) для создания бизнес-моделей из моделей данных.
**Из Domain в БД:**
1. Сервис передает класс-композитор (ClientModelComposite) в Репозиторий.
2. Репозиторий извлекает внутренние модели данных (@freezed) из композитора.
3. Репозиторий или DAO маппит модели данных в Companion модели таблиц (ClientsItemsCompanion) для сохранения в БД.

## Миграции

### Схема миграций
    
Для управления изменениями схемы базы данных используется система миграций Drift

### Автоматическая валидация схемы

Для обеспечения согласованности схемы БД реализована автоматическая валидация и обновление схемы при старте приложения

## Оптимизация и индексы

### Индексирование

В схеме базы данных определены следующие индексы для оптимизации запросов:

ClientsItems: индекс по имени и типу клиента для быстрого поиска
CarsItems: индексы по clientId, VIN и госномеру для быстрого поиска
OrdersItems: индексы по clientId, carId, статусу и дате создания
OrderPartsItems: индексы по orderId и артикулу запчасти
OrderServicesItems: индекс по orderId

## Оптимизированные запросы

Для улучшения производительности используются следующие подходы:
1. Использование индексов в запросах
2. Комплексные JOIN-запросы вместо множества простых
3. Использование транзакций для серии операций
4. Пакетная обработка данных для уменьшения количества запросов к БД
5. Кэширование часто запрашиваемых данных
6. Использование стримов для реактивного обновления данных
7. Параллельная обработка запросов для повышения производительности
8. Использование асинхронных операций для улучшения отзывчивости интерфейса
9. Регулярная оптимизация и анализ производительности запросов
10. Мониторинг и логирование медленных запросов для их последующей оптимизации
11. Использование EXPLAIN для анализа плана выполнения запросов
12. Мягкое удаление вместо физического удаления записей
13. Использование триггеров для автоматизации задач
14. Каскадное удаление связанных записей на уровне бизнес-логики
15. Регулярное резервное копирование и восстановление данных