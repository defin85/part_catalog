# Общая архитектура приложения

> Данный документ описывает высокоуровневую архитектуру приложения Part Catalog, разрабатываемого для разных платформ: десктоп (Windows, macOS, Linux), планшет и смартфон (iOS, Android).

## Содержание
- [Обзор](#обзор)
- [Архитектурные слои](#архитектурные-слои)
- [Ключевые компоненты](#ключевые-компоненты)
- [Взаимодействие между модулями](#взаимодействие-между-модулями)
- [Кросс-платформенная адаптация](#кросс-платформенная-адаптация)
- [Управление состоянием](#управление-состоянием)
- [Навигация](#навигация)
- [Внедрение зависимостей](#внедрение-зависимостей)
- [Локализация](#локализация)
- [Облачная интеграция](#облачная-интеграция)
- [Диаграммы](#диаграммы)

## Обзор

Part Catalog - это приложение для работников станций технического обслуживания автомобилей (СТО), обеспечивающее полный цикл учета клиентов, автомобилей, заказ-нарядов и подбора запчастей. Архитектура приложения построена с учетом мультиплатформенности и следует принципам чистой архитектуры (Clean Architecture).

### Технический стек:

Framework: Flutter
Язык программирования: Dart
База данных: Drift (SQLite) + Supabase для облачной синхронизации
Сетевые запросы: Dio
Управление состоянием: Provider/BLoC/Riverpod (выбрать предпочтительный)
Внедрение зависимостей: get_it
Навигация: go_router
Локализация: flutter_localizations + intl
Кодогенерация: build_runner + drift + freezed
Логгирование: logger

## Архитектурные слои

Архитектура приложения состоит из следующих слоев:

### 1. Presentation Layer (UI)

Назначение: Отвечает за пользовательский интерфейс и взаимодействие с пользователем
Компоненты: Экраны, виджеты, диалоги, провайдеры состояния
Особенности: Адаптивный дизайн для разных платформ и размеров экрана

### 2. Domain Layer (Business Logic)

Назначение: Содержит бизнес-логику приложения
Компоненты: Сервисы, use cases, бизнес-модели, репозитории (интерфейсы)
Особенности: Не зависит от UI и источников данных

### 3. Data Layer

Назначение: Обеспечивает доступ к данным из различных источников
Компоненты: Репозитории (реализации), API-клиенты, DAO, модели данных
Особенности: Преобразует данные между форматами API/БД и бизнес-моделями

### 4. Core Layer

Назначение: Содержит общие компоненты и утилиты
Компоненты: Логгеры, константы, расширения, утилитарные функции, инфраструктурный код
Особенности: Используется всеми другими слоями

## Ключевые компоненты

### База данных

Технология: Drift (SQLite wrapper)
Основные таблицы:
ClientsItems
CarsItems
OrdersItems
OrderPartsItems
OrderServicesItems
Особенности: Мягкое удаление, реактивные запросы, миграции
Синхронизация: Интеграция с Supabase для облачного хранения и синхронизации

### API интеграции

Каталоги запчастей: ApiClientPartsCatalogs
Поставщики запчастей:
Адаптивная архитектура с режимами direct/proxy/hybrid
Общая модель ответов для разных поставщиков
Кэширование результатов

### Модули

Клиенты: Управление физическими и юридическими лицами
Автомобили: Управление автомобилями клиентов
Заказ-наряды: Создание и отслеживание ремонтных работ
Поставщики: Получение цен и сроков поставки запчастей

## Взаимодействие между модулями

Модули взаимодействуют между собой через четко определенные интерфейсы, следуя принципам низкой связанности:

Клиенты → Автомобили: Клиент владеет автомобилями (связь один-ко-многим)
Автомобили → Заказ-наряды: Заказ-наряд связан с конкретным автомобилем
Клиенты → Заказ-наряды: Заказ-наряд связан с конкретным клиентом
Заказ-наряды → Поставщики: Заказ-наряд использует API поставщиков для получения цен на запчасти

## Кросс-платформенная адаптация

Приложение оптимизировано для работы на различных платформах и устройствах:

### Десктопные платформы (Windows, macOS, Linux)

Многооконный интерфейс с боковой навигацией
Табличное представление данных с сортировкой и фильтрацией
Поддержка горячих клавиш
Оптимизация для работы с мышью и клавиатурой

### Планшеты

Разделенный интерфейс (master-detail)
Адаптивное расположение элементов в зависимости от ориентации
Оптимизация для сенсорного ввода с поддержкой стилуса

### Смартфоны

Оптимизированный однооконный интерфейс
Адаптация под небольшие экраны
Оптимизация для управления одной рукой
Упрощенные формы ввода

## Управление состоянием

В приложении используется комбинация подходов к управлению состоянием:

Локальное состояние: StatefulWidget для локального UI-состояния
Глобальное состояние: Provider/BLoC/Riverpod
Персистентное состояние: Drift (SQLite)
Реактивное состояние: Stream-based подход с использованием реактивных запросов Drift

## Навигация

Навигация в приложении осуществляется с помощью go_router, который обеспечивает:

Декларативное определение маршрутов
Вложенную навигацию
Поддержку deep linking
Различные стратегии навигации для разных платформ

## Внедрение зависимостей

Для управления зависимостями используется get_it, который обеспечивает:

Ленивую инициализацию компонентов
Регистрацию синглтонов и фабрик
Модульную регистрацию зависимостей по feature-modules
Разрешение зависимостей во время выполнения

## Локализация

Для поддержки различных языков в приложении используется система локализации:

Технологии: flutter_localizations, intl пакеты
Структура: Текстовые ресурсы хранятся в .arb файлах для каждого поддерживаемого языка
Управление: Автоматическая генерация кода для доступа к локализованным строкам
Поддерживаемые языки: Русский, Английский (с возможностью расширения)
Форматирование: Локализованное форматирование дат, валют и чисел

```dart
// Пример использования локализации
Text(AppLocalizations.of(context)!.clientNameLabel),

// Пример локализованного форматирования
Text(NumberFormat.currency(
  locale: Localizations.localeOf(context).toString(),
  symbol: '₽',
).format(order.totalAmount)),
```

## Облачная интеграция

Приложение поддерживает гибридный режим работы с локальными и облачными данными через Supabase:

Основные возможности Supabase в приложении
Синхронизация данных: Двунаправленная синхронизация между локальной базой и облаком
Аутентификация: Поддержка входа через различные провайдеры (email/пароль, Google, Apple)
Управление правами: Настройка доступа к данным на основе ролей пользователей
Уведомления: Реализация серверных уведомлений через Postgres Realtime
Хранилище: Загрузка и хранение файлов и изображений
Функции: Выполнение серверной логики через Edge Functions

### Архитектура интеграции с Supabase

```
┌─────────────────┐      ┌───────────────────┐      ┌──────────────────┐
│  Local Database │◄────►│ Sync Coordinator  │◄────►│ Supabase Client  │
│     (Drift)     │      │                   │      │                  │
└─────────────────┘      └───────────────────┘      └─────────┬────────┘
                                                              │
                                                              ▼
                                                    ┌──────────────────┐
                                                    │  Supabase Cloud  │
                                                    │                  │
                                                    └──────────────────┘
```

### Стратегия синхронизации

Оффлайн-режим: Приложение полноценно работает без интернета с локальной базой
Фоновая синхронизация: При появлении соединения изменения автоматически синхронизируются
Разрешение конфликтов: Стратегии для разрешения конфликтов при одновременном редактировании
Состояние синхронизации: Индикаторы, показывающие статус синхронизации данных

## Диаграммы

### Высокоуровневая архитектура

```
┌────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│                                                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Клиенты UI  │  │Автомобили UI │  │Заказ-наряды UI│ ... │
│  └──────┬───────┘  └───────┬──────┘  └───────┬──────┘      │
└─────────┼────────────────┬─┼──────────────┬──┼─────────────┘
          │                │ │              │  │
┌─────────┼────────────────┼─┼──────────────┼──┼─────────────┐
│         │   Domain Layer  │ │              │  │             │
│         │                 │ │              │  │             │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌─────▼───────┐        │
│  │ClientService│  │ CarService   │  │OrderService │   ...   │
│  └──────┬──────┘  └───────┬──────┘  └─────┬───────┘        │
└─────────┼────────────────┬┼───────────────┼────────────────┘
          │                ││               │
┌─────────┼────────────────┼┼───────────────┼────────────────┐
│         │    Data Layer   ││               │                │
│         │                 ││               │                │
│  ┌──────▼─────┐  ┌────────▼─────┐  ┌──────▼─────┐          │
│  │ClientsDao  │  │   CarsDao    │  │ OrdersDao  │    ...    │
│  └──────┬─────┘  └──────┬───────┘  └──────┬─────┘          │
└─────────┼─────────────┬─┼─────────────────┼────────────────┘
          │             │ │                 │
┌─────────┼─────────────┼─┼─────────────────┼────────────────┐
│         │             │ │ Core Layer      │                │
│  ┌──────▼─────────────▼─▼─────────────────▼─────┐          │
│  │                 AppDatabase                   │          │
│  └──────────────────────────────────────────────┘          │
│                                                            │
│  ┌───────────────────┐  ┌──────────────────────┐           │
│  │   ApiClients      │  │   ServiceLocator     │    ...    │
│  └───────────────────┘  └──────────────────────┘           │
└────────────────────────────────────────────────────────────┘
```

### Взаимодействие компонентов

```
┌─────────────┐      ┌─────────────┐      ┌────────────────┐
│  UI Widget  │─────▶│  Service    │─────▶│  Repository    │
└─────────────┘      └─────────────┘      └────────────────┘
                                                   │
                                                   ▼
                                          ┌────────────────┐
                                          │ Data Source    │
                                          │ (API, Database)│
                                          └────────────────┘
```

### Многоуровневое хранение данных

```
┌────────────────────────────────────────────────────────────────┐
│              Пользовательский интерфейс (UI)                   │
└────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Провайдеры состояния (State Management)            │
└─────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Сервисы (Services)                                 │
└─────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Репозитории (Repositories)                         │
└─────────────────────────────────────────────────────────────────┘
          │                │                   │
          ▼                ▼                   ▼
┌───────────────────┐ ┌──────────────┐ ┌─────────────────────┐
│   Локальная БД    │ │  REST API    │ │ Supabase Cloud      │
│     (Drift)       │ │  клиенты     │ │ (PostgreSQL/Storage)│
└───────────────────┘ └──────────────┘ └─────────────────────┘
```