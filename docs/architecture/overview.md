# Общая архитектура приложения

> Данный документ описывает высокоуровневую архитектуру приложения Part Catalog, разрабатываемого для разных платформ: десктоп (Windows, macOS, Linux), планшет и смартфон (iOS, Android).

## Содержание
- [Обзор](#обзор)
- [Гибридная архитектура: 1С и DDD](#гибридная-архитектура-1с-и-ddd)
- [Архитектурные слои](#архитектурные-слои)
- [Ключевые компоненты](#ключевые-компоненты)
- [Взаимодействие между модулями](#взаимодействие-между-модулями)
- [Кросс-платформенная адаптация](#кросс-платформенная-адаптация)
- [Управление состоянием](#управление-состоянием)
- [Навигация](#навигация)
- [Внедрение зависимостей](#внедрение-зависимостей)
- [Локализация](#локализация)
- [Облачная интеграция](#облачная-интеграция)
- [Диаграммы](#диаграммы)

## Обзор

Part Catalog - это приложение для работников станций технического обслуживания автомобилей (СТО), обеспечивающее полный цикл учета клиентов, автомобилей, заказ-нарядов и подбора запчастей. Архитектура приложения построена с учетом мультиплатформенности и следует принципам гибридной архитектуры, сочетающей подходы 1С и Domain-Driven Design (DDD).

### Технический стек:

Framework: Flutter
Язык программирования: Dart
База данных: Drift (SQLite) + Supabase для облачной синхронизации
Сетевые запросы: Dio
Управление состоянием: Provider/BLoC/Riverpod (выбрать предпочтительный)
Внедрение зависимостей: get_it
Навигация: go_router
Локализация: flutter_localizations + intl
Кодогенерация: build_runner + drift + freezed
Логгирование: logger

## Гибридная архитектура: 1С и DDD

Приложение использует гибридную архитектуру, сочетающую лучшие практики из 1С и Domain-Driven Design (DDD). Этот подход позволяет объединить привычные для бизнеса концепции 1С с современными методиками проектирования сложных систем.

### Элементы архитектуры 1С

В нашей архитектуре используются следующие концепции, заимствованные из 1С:

1. **Документоцентрический подход** - основные бизнес-операции оформляются как документы (заказ-наряды)
2. **Справочники** - для работы с относительно постоянной информацией (клиенты, автомобили)
3. **Регистры** - для учета движений и состояний (наличие запчастей, статусы заказ-нарядов)
4. **Формы представления данных** - для унифицированного отображения и взаимодействия с данными

### Элементы Domain-Driven Design (DDD)

Одновременно архитектура включает основные концепции DDD:

1. **Предметная область (Domain)** - выделение бизнес-логики в отдельный слой
2. **Единый язык (Ubiquitous Language)** - использование общих терминов между разработчиками и специалистами предметной области
3. **Агрегаты (Aggregates)** и **корни агрегатов (Aggregate Roots)** - для обеспечения целостности данных. Реализуются через **классы-композиторы** (например, `OrderModelComposite`), которые инкапсулируют состояние и поведение агрегата
4. **Репозитории (Repositories)** - для доступа к хранилищу данных
5. **Сервисы предметной области (Domain Services)** - для реализации сложной бизнес-логики

### Преимущества гибридного подхода:

1. **Понятность для бизнес-пользователей** - использование привычной терминологии и концепций из 1С
2. **Масштабируемость и поддерживаемость** - благодаря принципам DDD
3. **Четкое разделение ответственности** - каждый компонент имеет строго определенную функцию
4. **Гибкость при изменении требований** - изолированные компоненты позволяют менять отдельные части системы

### Стратегия идентификации данных

В данной системе применяется следующий подход к идентификаторам:
- БД использует integer ID (автоинкремент)
- Бизнес-модели используют String ID (UUID)
- Для новых объектов генерируется UUID
- При получении данных из БД ID преобразуется в String

Этот подход обеспечивает:
1. Эффективное хранение и индексирование в базе данных
2. Возможность создания новых объектов без доступа к БД
3. Упрощение синхронизации с облачными сервисами
4. Предотвращение конфликтов при работе нескольких устройств

## Архитектурные слои

Архитектура приложения состоит из следующих слоев:

### 1. Presentation Layer (UI)

Назначение: Отвечает за пользовательский интерфейс и взаимодействие с пользователем
Компоненты: 
- Экраны (аналог форм в 1С) 
- Виджеты (аналог элементов управления) 
- Диалоги
- Провайдеры состояния
Особенности: Адаптивный дизайн для разных платформ и размеров экрана

### 2. Application Layer

Назначение: Координирует действия между UI и Domain слоем, не содержит бизнес-логику
Компоненты:
- Use cases (сценарии использования)
- Application services (сервисы приложения)
- DTOs (объекты передачи данных)
Особенности: Организует рабочие процессы, но не содержит бизнес-правил

### 3. Domain Layer (Business Logic)

Назначение: Содержит бизнес-логику приложения и моделирует предметную область
Компоненты:
- **Интерфейсы сущностей** (`IEntity`, `IDocumentEntity`, `IItemEntity`...) - определяют контракты.
- **Классы-композиторы** (`OrderModelComposite`, `ClientModelComposite`...) - реализуют интерфейсы, инкапсулируют данные и поведение. Являются основными бизнес-моделями.
- **Модели данных (`@freezed`)** (`EntityCoreData`, `DocumentSpecificData`, `OrderSpecificData`...) - чистые, иммутабельные структуры для хранения данных. Используются внутри классов-композиторов.
- **Value Objects** (объекты-значения)
- **Domain Services** (сервисы предметной области)
- **Domain Events** (события предметной области)
Особенности: Не зависит от UI и источников данных, содержит правила и бизнес-логику. Данные хранятся в иммутабельных структурах.

### 4. Infrastructure Layer

Назначение: Обеспечивает доступ к данным из различных источников
Компоненты: 
- Repositories (репозитории - реализации)
- Data Access Objects (DAO)
- API Clients (клиенты API)
- Persistence Models (модели хранения данных - аналоги таблиц в 1С)
Особенности: Преобразует данные между форматами API/БД и **моделями данных (`@freezed`)**, которые затем используются **классами-композиторами** доменного слоя.

### 5. Core Layer (Shared Kernel)

Назначение: Содержит общие компоненты и утилиты
Компоненты: 
- Логгеры
- Константы
- Расширения
- Утилитарные функции
- Инфраструктурный код
Особенности: Используется всеми другими слоями

## Ключевые компоненты

### База данных

Технология: Drift (SQLite wrapper)
Основные таблицы:
ClientsItems (аналог справочника "Контрагенты" в 1С)
CarsItems (аналог справочника "Транспортные средства" в 1С)
OrdersItems (аналог документа "Заказ-наряд" в 1С)
OrderPartsItems (аналог табличной части документа в 1С)
OrderServicesItems (аналог табличной части документа в 1С)
Особенности: Мягкое удаление, реактивные запросы, миграции
Синхронизация: Интеграция с Supabase для облачного хранения и синхронизации

### API интеграции

Каталоги запчастей: ApiClientPartsCatalogs
Поставщики запчастей:
- Адаптивная архитектура с режимами direct/proxy/hybrid
- Общая модель ответов для разных поставщиков
- Кэширование результатов

### Модули (Bounded Contexts в терминологии DDD)

Клиенты: Управление физическими и юридическими лицами (реализует справочник "Контрагенты")
Автомобили: Управление автомобилями клиентов (реализует справочник "Транспортные средства")
Заказ-наряды: Создание и отслеживание ремонтных работ (реализует документ "Заказ-наряд")
Поставщики: Получение цен и сроков поставки запчастей (реализует службу интеграции)

## Взаимодействие между модулями

Модули взаимодействуют между собой через четко определенные интерфейсы, следуя принципам низкой связанности и антикоррупционных слоев (Anti-Corruption Layers) из DDD:

Клиенты → Автомобили: Клиент владеет автомобилями (связь один-ко-многим)
Автомобили → Заказ-наряды: Заказ-наряд связан с конкретным автомобилем
Клиенты → Заказ-наряды: Заказ-наряд связан с конкретным клиентом
Заказ-наряды → Поставщики: Заказ-наряд использует API поставщиков для получения цен на запчасти

## Кросс-платформенная адаптация

Приложение оптимизировано для работы на различных платформах и устройствах:

### Десктопные платформы (Windows, macOS, Linux)

Многооконный интерфейс с боковой навигацией
Табличное представление данных с сортировкой и фильтрацией
Поддержка горячих клавиш
Оптимизация для работы с мышью и клавиатурой

### Планшеты

Разделенный интерфейс (master-detail)
Адаптивное расположение элементов в зависимости от ориентации
Оптимизация для сенсорного ввода с поддержкой стилуса

### Смартфоны

Оптимизированный однооконный интерфейс
Адаптация под небольшие экраны
Оптимизация для управления одной рукой
Упрощенные формы ввода

## Управление состоянием

В приложении используется комбинация подходов к управлению состоянием:

Локальное состояние: StatefulWidget для локального UI-состояния
Глобальное состояние: Provider/BLoC/Riverpod
Персистентное состояние: Drift (SQLite)
Реактивное состояние: Stream-based подход с использованием реактивных запросов Drift

## Навигация

Навигация в приложении осуществляется с помощью go_router, который обеспечивает:

Декларативное определение маршрутов
Вложенную навигацию
Поддержку deep linking
Различные стратегии навигации для разных платформ

## Внедрение зависимостей

Для управления зависимостями используется get_it, который обеспечивает:

Ленивую инициализацию компонентов
Регистрацию синглтонов и фабрик
Модульную регистрацию зависимостей по feature-modules
Разрешение зависимостей во время выполнения

## Локализация

Для поддержки различных языков в приложении используется система локализации:

Технологии: flutter_localizations, intl пакеты
Структура: Текстовые ресурсы хранятся в .arb файлах для каждого поддерживаемого языка
Управление: Автоматическая генерация кода для доступа к локализованным строкам
Поддерживаемые языки: Русский, Английский (с возможностью расширения)
Форматирование: Локализованное форматирование дат, валют и чисел

```dart
// Пример использования локализации
Text(AppLocalizations.of(context)!.clientNameLabel),

// Пример локализованного форматирования
Text(NumberFormat.currency(
  locale: Localizations.localeOf(context).toString(),
  symbol: '₽',
).format(order.totalAmount)),
```

## Облачная интеграция

Приложение поддерживает гибридный режим работы с локальными и облачными данными через Supabase:

Основные возможности Supabase в приложении
Синхронизация данных: Двунаправленная синхронизация между локальной базой и облаком
Аутентификация: Поддержка входа через различные провайдеры (email/пароль, Google, Apple)
Управление правами: Настройка доступа к данным на основе ролей пользователей
Уведомления: Реализация серверных уведомлений через Postgres Realtime
Хранилище: Загрузка и хранение файлов и изображений
Функции: Выполнение серверной логики через Edge Functions

### Архитектура интеграции с Supabase

```
┌─────────────────┐      ┌───────────────────┐      ┌──────────────────┐
│  Local Database │◄────►│ Sync Coordinator  │◄────►│ Supabase Client  │
│     (Drift)     │      │                   │      │                  │
└─────────────────┘      └───────────────────┘      └─────────┬────────┘
                                                              │
                                                              ▼
                                                    ┌──────────────────┐
                                                    │  Supabase Cloud  │
                                                    │                  │
                                                    └──────────────────┘
```

### Стратегия синхронизации

Оффлайн-режим: Приложение полноценно работает без интернета с локальной базой
Фоновая синхронизация: При появлении соединения изменения автоматически синхронизируются
Разрешение конфликтов: Стратегии для разрешения конфликтов при одновременном редактировании
Состояние синхронизации: Индикаторы, показывающие статус синхронизации данных

## Диаграммы

<!-- ...existing code... -->
### Высокоуровневая архитектура с учетом гибридного подхода

```
┌────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│                (Формы и элементы управления)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Клиенты UI  │  │Автомобили UI │  │Заказ-наряды UI│ ... │
│  └──────┬───────┘  └───────┬──────┘  └───────┬──────┘      │
└─────────┼────────────────┬─┼──────────────┬──┼─────────────┘
          │                │ │              │  │
┌─────────┼────────────────┼─┼──────────────┼──┼─────────────┐
│         │  Application Layer               │  │             │
│         │   (Use Cases, DTOs)              │  │             │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌─────▼───────┐        │
│  │ClientUseCase│  │ CarUseCase   │  │OrderUseCase │   ...   │
│  └──────┬──────┘  └───────┬──────┘  └─────┬───────┘        │
└─────────┼────────────────┬┼───────────────┼────────────────┘
          │                ││               │
┌─────────┼────────────────┼┼───────────────┼────────────────┐
│         │   Domain Layer  ││               │                │
│      (Бизнес-логика, Композиторы, Интерфейсы, Сервисы)     │
│  ┌──────▼──────┐  ┌───────▼──────┐  ┌─────▼───────┐        │
│  │ClientService│  │ CarService   │  │OrderService │   ...   │
│  │(работает с  │  │(работает с   │  │(работает с   │        │
│  │IClientEntity│  │ICarEntity)   │  │IDocumentEntity)│       │
│  │/ClientModel │  │/CarModel     │  │/OrderModel   │        │
│  │Composite)   │  │Composite)    │  │Composite)    │        │
│  └──────┬──────┘  └───────┬──────┘  └─────┬───────┘        │
└─────────┼────────────────┬┼───────────────┼────────────────┘
          │                ││               │
┌─────────┼────────────────┼┼───────────────┼────────────────┐
│         │ Infrastructure Layer            │                │
│         │ (Репозитории, DAO, Модели данных @freezed)      │
│  ┌──────▼─────┐  ┌────────▼─────┐  ┌──────▼─────┐          │
│  │ClientsRepo │  │   CarsRepo   │  │ OrdersRepo │    ...    │
│  │(возвращает │  │(возвращает   │  │(возвращает  │          │
│  │EntityCore..│  │CarSpecific.. │  │OrderSpecific.│          │
│  │/ClientData)│  │/ItemCoreData)│  │/DocSpecific..)│         │
│  └──────┬─────┘  └──────┬───────┘  └──────┬─────┘          │
└─────────┼─────────────┬─┼─────────────────┼────────────────┘
          │             │ │                 │
┌─────────┼─────────────┼─┼─────────────────┼────────────────┐
│         │             │ │ Core Layer      │                │
│         │             │ │(Shared Kernel)  │                │
│  ┌──────▼─────────────▼─▼─────────────────▼─────┐          │
│  │                 AppDatabase                   │          │
│  └──────────────────────────────────────────────┘          │
│                                                            │
│  ┌───────────────────┐  ┌──────────────────────┐           │
│  │   ApiClients      │  │   ServiceLocator     │    ...    │
│  └───────────────────┘  └──────────────────────┘           │
└────────────────────────────────────────────────────────────┘
```

### Взаимодействие компонентов в гибридной архитектуре

```
┌─────────────┐      ┌─────────────┐      ┌────────────────┐      ┌───────────────┐
│  UI Widget  │─────▶│  Use Case   │─────▶│Domain Service  │─────▶│  Repository   │
│  (Форма)    │      │ (Сценарий)  │      │(Бизнес-логика) │      │  (Хранение)   │
└─────────────┘      └─────────────┘      └────────────────┘      └───────┬───────┘
                                                                          │
                                                                          ▼
                                                                 ┌────────────────┐
                                                                 │ Data Source    │
                                                                 │(БД, API и др.) │
                                                                 └────────────────┘
```

### Многоуровневое хранение данных

```
┌────────────────────────────────────────────────────────────────┐
│              Пользовательский интерфейс (UI)                   │
└────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Провайдеры состояния (State Management)            │
└─────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Сервисы (Services)                                 │
└─────────────────────────────────────────────────────────────────┘
                  │                      ▲
                  ▼                      │
┌─────────────────────────────────────────────────────────────────┐
│              Репозитории (Repositories)                         │
└─────────────────────────────────────────────────────────────────┘
          │                │                   │
          ▼                ▼                   ▼
┌───────────────────┐ ┌──────────────┐ ┌─────────────────────┐
│   Локальная БД    │ │  REST API    │ │ Supabase Cloud      │
│     (Drift)       │ │  клиенты     │ │ (PostgreSQL/Storage)│
└───────────────────┘ └──────────────┘ └─────────────────────┘
```