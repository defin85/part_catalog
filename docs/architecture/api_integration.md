# Интеграция с внешними API

> Документ описывает архитектуру и принципы интеграции с внешними API поставщиков запчастей в приложении Part Catalog.

## Содержание
- [Обзор](#обзор)
- [Архитектура API-интеграций](#архитектура-api-интеграций)
- [Режимы подключения](#режимы-подключения)
- [Основные компоненты](#основные-компоненты)
- [Обработка ошибок](#обработка-ошибок)
- [Оптимизация производительности](#оптимизация-производительности)
- [Безопасность](#безопасность)
- [Мониторинг и логирование](#мониторинг-и-логирование)

## Обзор

Part Catalog взаимодействует с двумя типами внешних API:

1. API каталогов запчастей - для поиска запчастей по VIN-коду и артикулу
2. API поставщиков запчастей - для получения информации о ценах и сроках поставки

Взаимодействие с этими API реализовано через слой абстракции, который позволяет:

* Унифицировать доступ к разным API
* Изолировать бизнес-логику от деталей реализации API
* Обеспечить гибкое переключение между режимами работы

## Архитектура API-интеграций

### Общая схема

```mermaid
┌─────────────────┐     ┌───────────────┐     ┌────────────────────┐
│                 │     │               │     │                    │
│  UI Components  │───▶│  API Services │────▶│  API Clients       │
│                 │     │               │     │                    │
└─────────────────┘     └───────────────┘     └────────────┬───────┘
                                                           │
                                                           ▼
                                                 ┌────────────────────┐
                                                 │                    │
                                                 │  External APIs     │
                                                 │                    │
                                                 └────────────────────┘
```

### Разделение ответственности

UI Components - отображение данных и взаимодействие с пользователем
API Services - бизнес-логика, обработка данных, агрегация результатов
API Clients - низкоуровневая работа с API, сетевые запросы, сериализация/десериализация
External APIs - внешние системы, с которыми взаимодействует приложение

## Режимы подключения

Приложение поддерживает три режима работы с API поставщиков:

Режим	Описание	Применение
Direct	Прямое подключение к API	Разработка, тестирование, автономная работа
Proxy	Через прокси-сервер	Продакшн, корпоративные развертывания
Hybrid	Автоматическое переключение	Повышенная отказоустойчивость

### Прямое подключение (Direct)

В этом режиме приложение напрямую обращается к API каждого поставщика:

```
┌────────────────┐     ┌──────────────┐     ┌────────────────┐
│                │     │              │     │                │
│  Flutter App   │────▶│ API Client 1 │────▶│  Provider 1    │
│                │     │              │     │                │
└────────────────┘     └──────────────┘     └────────────────┘
         │                                         
         │             ┌──────────────┐     ┌────────────────┐
         │             │              │     │                │
         └────────────▶│ API Client 2 │────▶│  Provider 2    │
                       │              │     │                │
                       └──────────────┘     └────────────────┘
```

**Преимущества:**

* Простота реализации
* Отсутствие дополнительных задержек
* Независимость от дополнительной инфраструктуры

**Ограничения:**

* API-ключи хранятся на клиенте
* Каждое устройство использует собственную квоту запросов
* Сложности с единым мониторингом

### Через прокси-сервер (Proxy)

В этом режиме запросы проходят через промежуточный сервер:

```
┌────────────────┐     ┌─────────────┐     ┌────────────────┐
│                │     │             │     │                │
│  Flutter App   │────▶│ Proxy Server│────▶│  Provider 1    │
│                │     │             │     │                │
└────────────────┘     └─────────────┘     └────────────────┘
                              │                    
                              │            ┌────────────────┐
                              │            │                │
                              └───────────▶│  Provider 2    │
                                           │                │
                                           └────────────────┘
```

**Преимущества:**

* Безопасное хранение API-ключей на сервере
* Централизованный мониторинг и кэширование
* Оптимизация расхода квот запросов
* Унификация ответов разных API

**Ограничения:**

* Необходимость поддержки дополнительного сервера
* Дополнительная задержка при запросах
* Зависимость от доступности прокси-сервера

### Гибридный режим (Hybrid)

Комбинирует преимущества обоих подходов с автоматическим переключением:

```
┌────────────────┐     ┌─────────────┐     ┌────────────────┐
│                │────▶│             │────▶│                │
│                │     │ Proxy Server│     │  Provider 1    │
│                │     │             │     │                │
│  Flutter App   │     └─────────────┘     └────────────────┘
│                │                                
│                │     ┌─────────────┐     ┌────────────────┐
│                │────▶│             │────▶│                │
└────────────────┘     │Direct Client│     │  Provider 2    │
                       │             │     │                │
                       └─────────────┘     └────────────────┘
```

**Преимущества:**

* Повышенная отказоустойчивость
* Автоматическое переключение при проблемах
* Сочетает преимущества обоих подходов

**Ограничения:**

* Повышенная сложность реализации
* Необходимость поддержки обоих режимов
* Сложности с отладкой и тестированием

## Основные компоненты

### ApiClientPartsCatalogs

Централизованный клиент для работы с API каталогов запчастей

### SupplierApiClient

Базовый интерфейс для всех клиентов API поставщиков запчастей

### SuppliersService

Сервис-агрегатор для работы со всеми поставщиками

### ApiClientManager

Фабрика для создания API-клиентов с учетом режима работы

## Обработка ошибок

### Иерархия исключений

```dart
/// Базовое исключение для всех API-ошибок
abstract class ApiException implements Exception {
  final String message;
  final dynamic cause;
  
  const ApiException(this.message, {this.cause});
}

/// Исключение при ошибках сети
class NetworkException extends ApiException {
  final int? statusCode;
  
  NetworkException(
    super.message, {
    this.statusCode,
    super.cause,
  });
}

/// Исключение при ошибках в ответе API
class ApiResponseException extends ApiException {
  final String? errorCode;
  
  ApiResponseException(
    super.message, {
    this.errorCode,
    super.cause,
  });
}

/// Исключение при ошибках конфигурации
class ConfigurationException extends ApiException {
  ConfigurationException(super.message, {super.cause});
}
```

### Стратегия обработки ошибок

1. Локальная обработка - специфичные для поставщика ошибки обрабатываются в API-клиенте
2. Преобразование - внешние ошибки преобразуются в унифицированные исключения приложения
3. Каскадная обработка - ошибки проходят вверх по стеку вызовов до соответствующего обработчика

## Оптимизация производительности

### Кэширование

Для снижения нагрузки на API и улучшения отзывчивости приложения реализовано многоуровневое кэширование:

1. Кратковременное кэширование - в памяти для частых запросов в рамках сессии
2. Долговременное кэширование - локальное хранение результатов запросов
3. Серверное кэширование - при использовании прокси-сервера

### Дебаунсинг и троттлинг

Для предотвращения избыточных запросов при часто обновляемых данных

### Параллельные запросы

Для ускорения получения данных от нескольких поставщиков используются параллельные запросы

## Безопасность

### Защита API-ключей

В режиме direct: API-ключи хранятся в зашифрованном виде с использованием flutter_secure_storage
В режиме proxy: API-ключи хранятся только на сервере, клиент использует JWT-токены

### Защита передаваемых данных

Использование HTTPS для всех запросов
Минимизация передаваемых персональных данных
Валидация всех входящих данных от API

## Мониторинг и логирование

### Системное логирование

### Метрики и аналитика

* Время ответа API
* Количество запросов по типам и поставщикам
* Частота ошибок и их типы
* Объем передаваемых данных

### Мониторинг доступности

Автоматическая проверка доступности API для раннего обнаружения проблем