# Модуль автомобилей

> Модуль автомобилей обеспечивает управление информацией об автомобилях клиентов СТО, включая их характеристики и связь с владельцами.

## Содержание
- [Назначение](#назначение)
- [Архитектура](#архитектура)
- [Основные компоненты](#основные-компоненты)
- [Модели данных](#модели-данных)
- [Основные операции](#основные-операции)
- [UI компоненты](#ui-компоненты)
- [Адаптивный интерфейс](#адаптивный-интерфейс)
- [Типичные сценарии использования](#типичные-сценарии-использования)

## Назначение

Модуль автомобилей решает следующие задачи:
- Учет автомобилей клиентов СТО
- Хранение технических характеристик автомобилей (марка, модель, VIN-код)
- Связь автомобилей с их владельцами (клиентами)
- Предоставление интерфейса для создания, редактирования и удаления автомобилей

## Архитектура

Модуль следует принципам чистой архитектуры и использует архитектуру "Композиция + Интерфейсы + `@freezed`". Он состоит из следующих уровней:

|   Уровень       | Назначение                    | Компоненты                    |
|-----------------|-------------------------------|-------------------------------|
|   Presentation  | Пользовательский интерфейс    | `CarsScreen`, `CarFormDialog`, `CarDetailsScreen` |
|   Domain        | Бизнес-логика                 | `CarService`, `CarModelComposite`, `ICarEntity` (если нужен специфичный интерфейс) |
|   Data          | Доступ к данным               | `CarsDao`, `CarsItemsCompanion`, `EntityCoreData`, `CarSpecificData` (`@freezed` модели) |

## Основные компоненты

### CarService

Сервисный класс для работы с автомобилями. Основные методы:

Функциональность: Управляет бизнес-логикой автомобилей, работает с бизнес-моделями (`CarModelComposite`) и интерфейсами (`IEntity` или `ICarEntity`). Координирует взаимодействие с DAO для получения/сохранения данных, преобразуя `@freezed` модели данных (`EntityCoreData`, `CarSpecificData`) в бизнес-модели (`CarModelComposite`) и обратно.
Ключевые методы:
- **getCars()**: Получение списка `CarModelComposite`.
- **watchCarsWithOwners()**: Реактивное наблюдение за списком `CarWithOwnerModel` (содержащим `CarModelComposite`).
- **getCarById(String carUuid)**: Получение `CarModelComposite` по UUID.
- **addCar(CarModelComposite car)**: Добавление нового автомобиля.
- **updateCar(CarModelComposite car)**: Обновление данных автомобиля.
- **deleteCar(String carUuid)**: Мягкое удаление автомобиля.
- **getCarsByClientId(String clientUuid)**: Получение списка `CarModelComposite` для конкретного клиента.

### CarsDao

Data Access Object для прямого взаимодействия с таблицей `CarsItems` в базе данных:

Функциональность: Предоставляет низкоуровневый доступ к данным таблицы. Получает данные в виде моделей таблиц (`CarsItem`) и маппит их в соответствующие `@freezed` модели данных (`EntityCoreData`, `CarSpecificData`) для передачи в сервисный слой. При сохранении принимает `Companion` объекты, созданные из `@freezed` моделей данных.
Ключевые методы:
- **getActiveCars()**: Получение данных для активных автомобилей.
- **watchCarsWithOwners()**: Реактивное наблюдение за данными автомобилей с информацией о владельцах.
- **getCarById(int id)**: Получение данных автомобиля по ID таблицы.
- **insertCar(CarsItemsCompanion car)**: Вставка нового автомобиля (принимает `Companion`).
- **updateCar(CarsItemsCompanion car)**: Обновление информации об автомобиле (принимает `Companion`).
- **softDeleteCar(int carId)**: Мягкое удаление автомобиля.
- **softDeleteCarsByClientId(int clientId)**: Мягкое удаление всех автомобилей клиента.

## Модели данных

### Модели таблиц (Drift)

- `CarsItems`: Структура таблицы автомобилей в БД. Содержит все поля, включая `clientId`, `make`, `model`, `vin` и т.д.

### Модели данных (`@freezed`)

Чистые, иммутабельные структуры для хранения данных, используемые для передачи между слоями Data и Domain:
- `EntityCoreData`: Базовые данные сущности (uuid, code, displayName...).
- `CarSpecificData`: Специфичные данные автомобиля (clientId, make, model, year, vin, licensePlate, additionalInfo).

### Бизнес-модели (Композиторы)

Классы, реализующие интерфейсы (`IEntity` или `ICarEntity`) и инкапсулирующие `@freezed` модели данных. Представляют автомобиль в бизнес-логике:
- `CarModelComposite`: Представляет автомобиль. Содержит `EntityCoreData` и `CarSpecificData`. Реализует `IEntity` (или `ICarEntity`). Предоставляет геттеры для всех полей и методы `with...` для иммутабельного обновления.

### Модели представления (View Models)

- `CarWithOwnerModel`: Объединяет бизнес-модель автомобиля (`CarModelComposite`) с информацией о владельце (например, `ownerName`, `ownerType`) для удобного отображения в UI.

## Основные операции

### Отображение списка автомобилей с владельцами

Реализуется через реактивные потоки данных (`watchCarsWithOwners` в `CarService`), которые возвращают `Stream<List<CarWithOwnerModel>>`. UI подписывается на этот поток и автоматически обновляется при изменениях в данных автомобилей или их владельцев.

### Добавление/редактирование автомобиля

Процесс включает:
- Выбор клиента (получение `ClientModelComposite`).
- Ввод характеристик автомобиля в UI.
- Создание или обновление экземпляра `CarModelComposite` через его фабричный конструктор или методы `with...`.
- Вызов `addCar` или `updateCar` в `CarService`, который выполняет маппинг в `@freezed` модели и передает их в DAO для сохранения.
- Валидация данных (обязательные поля, уникальность VIN) выполняется на уровне сервиса или UI.

### Связь с другими модулями

- **Клиенты:** Каждый `CarModelComposite` связан с `ClientModelComposite` через `clientId` (хранится в `CarSpecificData`).
- **Заказ-наряды:** `CarModelComposite` используется при создании `OrderModelComposite` для указания объекта ремонта.
- **Каталог запчастей:** `CarModelComposite` (особенно VIN) может использоваться для поиска запчастей в модуле каталогов.

## UI компоненты

### CarsScreen

Основной экран управления автомобилями:
- Отображает список `CarWithOwnerModel`, полученный от `CarService`.
- Предоставляет функции поиска и фильтрации.
- Инициирует создание нового автомобиля.

### CarFormDialog

Диалог или экран для добавления/редактирования `CarModelComposite`:
- Позволяет выбрать клиента (`ClientModelComposite`).
- Содержит поля для ввода характеристик автомобиля.
- Взаимодействует с `CarService` для сохранения данных.

### CarDetailsScreen

Экран детальной информации об автомобиле (`CarModelComposite`):
- Отображает полную информацию о характеристиках и владельце.
- Может отображать связанную информацию, например, историю заказ-нарядов (`OrderModelComposite`), полученную через соответствующие сервисы.

## Адаптивный интерфейс

Интерфейс модуля адаптируется для разных платформ:
- **Мобильные устройства:** Списки и отдельные экраны деталей.
- **Десктопные платформы:** Табличное представление, возможно, с редактированием в боковой панели или модальных окнах.
- **Планшеты:** Комбинированный интерфейс (master-detail).

## Типичные сценарии использования

1.  **Регистрация нового автомобиля клиента:** Пользователь находит клиента, открывает форму добавления автомобиля, вводит данные, сохраняет. `CarService` создает `CarModelComposite` и сохраняет его через DAO.
2.  **Поиск автомобиля по VIN или госномеру:** Пользователь вводит данные в поле поиска на `CarsScreen`. `CarService` выполняет поиск по соответствующим полям `CarModelComposite` (через DAO).
3.  **Привязка автомобиля к новому владельцу:** Пользователь редактирует `CarModelComposite`, изменяя `clientId`. `CarService` обновляет данные через DAO.
4.  **Просмотр истории заказ-нарядов:** На `CarDetailsScreen` запрашивается список `OrderModelComposite` для данного `CarModelComposite` через `OrderService`.